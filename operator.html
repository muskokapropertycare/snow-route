<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Snow Route - Operator</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#1565c0"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:#0a1628;color:#fff;height:100dvh;display:flex;flex-direction:column;overflow:hidden;}
#login-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;gap:14px;}
.app-logo{font-size:64px;line-height:1;}
.app-title{font-size:24px;font-weight:bold;color:#90caf9;}
.app-sub{font-size:14px;color:#78909c;margin-bottom:8px;}
.field{width:100%;max-width:340px;}
.field label{display:block;font-size:12px;color:#90caf9;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px;}
.field input{width:100%;padding:14px 16px;border-radius:12px;border:2px solid #1a3a6b;background:#0d2040;color:#fff;font-size:16px;outline:none;transition:border .2s;}
.field input:focus{border-color:#1565c0;}
#login-error{color:#ef5350;font-size:13px;min-height:16px;width:100%;max-width:340px;}
.btn{width:100%;max-width:340px;padding:15px;border-radius:12px;border:none;font-size:17px;font-weight:bold;cursor:pointer;}
.btn-blue{background:#1565c0;color:#fff;}
.btn-sm{padding:6px 13px;border-radius:8px;font-size:12px;width:auto;}
.btn-green{background:#2e7d32;color:#fff;}
.btn-gray{background:#37474f;color:#ccc;}
#app-screen{display:none;flex:1;flex-direction:column;overflow:hidden;}
#topbar{background:#1565c0;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
#topbar h1{font-size:17px;font-weight:bold;}
#topbar .right{display:flex;align-items:center;gap:8px;font-size:13px;}
#statusbar{background:#0d2040;padding:7px 14px;display:flex;justify-content:space-between;font-size:12px;color:#90caf9;flex-shrink:0;}
#map{flex:1;min-height:0;}
#prop-list{flex-shrink:0;height:230px;overflow-y:auto;background:#0d2040;border-top:2px solid #1565c0;}
.prop-item{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid #1a3a6b;gap:10px;}
.prop-item.done{opacity:.4;}
.stop-badge{flex-shrink:0;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:13px;border:2px solid rgba(255,255,255,.3);}
.stop-badge.pending{background:#c62828;}
.stop-badge.done{background:#2e7d32;}
.prop-text{flex:1;min-width:0;}
.prop-name{font-size:14px;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.prop-addr{font-size:11px;color:#78909c;margin-top:2px;}
.prop-status{font-size:11px;font-weight:bold;flex-shrink:0;}
.prop-status.done{color:#66bb6a;}
</style>
</head>
<body>
<div id="login-screen">
  <div class="app-logo">SNOW</div>
  <div class="app-title">Snow Route</div>
  <div class="app-sub">Driver Sign In</div>
  <div class="field"><label>Email</label><input type="email" id="inp-email" placeholder="you@example.com" autocomplete="email"/></div>
  <div class="field"><label>Password</label><input type="password" id="inp-pass" placeholder="Password" autocomplete="current-password"/></div>
  <div id="login-error"></div>
  <button class="btn btn-blue" id="signin-btn">Sign In</button>
</div>
<div id="app-screen">
  <div id="topbar">
    <h1>Snow Route</h1>
    <div class="right"><span id="driver-label"></span><button class="btn btn-gray btn-sm" id="signout-btn">Sign Out</button></div>
  </div>
  <div id="statusbar"><span id="prog-text">Loading...</span><span id="gps-text">Acquiring GPS...</span></div>
  <div id="map"></div>
  <div id="prop-list"></div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import{getAuth,signInWithEmailAndPassword,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import{getDatabase,ref,onValue,update,set,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDx5L68cyP4UbOnPLSeV8tuAzLg9znBtSE",
  authDomain:"snow-route-29bc5.firebaseapp.com",
  databaseURL:"https://snow-route-29bc5-default-rtdb.firebaseio.com",
  projectId:"snow-route-29bc5",
  storageBucket:"snow-route-29bc5.firebasestorage.app",
  messagingSenderId:"428738240151",
  appId:"1:428738240151:web:e71f764adaebe4ea73d3d2"
};

const PROPERTIES=[
  {id:"p1",order:1,name:"Condos",addr:"120 Anglo St, Bracebridge ON",lat:45.035209,lng:-79.311519},
  {id:"p2",order:2,name:"Elene",addr:"127 Milton St, Bracebridge ON",lat:45.033716,lng:-79.305076},
  {id:"p3",order:3,name:"Verla",addr:"59 Santas Village Rd, Bracebridge ON",lat:45.023742,lng:-79.358715},
  {id:"p4",order:4,name:"Lady 1",addr:"19 Gainsborough, Bracebridge ON",lat:45.031620,lng:-79.324650},
  {id:"p5",order:5,name:"Joe",addr:"16 Gainsborough, Bracebridge ON",lat:45.031750,lng:-79.324750},
  {id:"p6",order:6,name:"Lady 2",addr:"17 Gainsborough, Bracebridge ON",lat:45.031880,lng:-79.324850},
  {id:"p7",order:7,name:"Hough",addr:"23 Gainsborough, Bracebridge ON",lat:45.032100,lng:-79.325050},
  {id:"p8",order:8,name:"Anne Swan",addr:"1A MacArthur Dr, Bracebridge ON",lat:45.032074,lng:-79.328087},
  {id:"p9",order:9,name:"Mini Storage",addr:"1711 Winhara Rd, Bracebridge ON",lat:44.992892,lng:-79.309460},
  {id:"p10",order:10,name:"Flo",addr:"5 Memory Lane, Bracebridge ON",lat:45.010375,lng:-79.305802},
  {id:"p11",order:11,name:"Mary",addr:"1440 Cedar Lane, Bracebridge ON",lat:45.064385,lng:-79.304029},
  {id:"p12",order:12,name:"Derek",addr:"1200 Highfalls Rd, Bracebridge ON",lat:45.087478,lng:-79.315615},
  {id:"p13",order:13,name:"Salvation Army",addr:"118 Ann St, Bracebridge ON",lat:45.046717,lng:-79.310003},
  {id:"p14",order:14,name:"Helene",addr:"28 Milton St, Bracebridge ON",lat:45.033716,lng:-79.305076},
  {id:"p15",order:15,name:"Rivers Edge Condos",addr:"Rivers Edge Condos, Bracebridge ON",lat:45.039500,lng:-79.314000},
  {id:"p16",order:16,name:"Nordeman",addr:"90 Milton St, Bracebridge ON",lat:45.034200,lng:-79.306000},
  {id:"p17",order:17,name:"Cathy",addr:"127 Milton St, Bracebridge ON",lat:45.033716,lng:-79.305076},
  {id:"p18",order:18,name:"Nordeman 2 driveways",addr:"3 King St, Bracebridge ON",lat:45.039200,lng:-79.304600},
  {id:"p19",order:19,name:"Erik",addr:"33 King St, Bracebridge ON",lat:45.039400,lng:-79.304800},
  {id:"p20",order:20,name:"Nordeman",addr:"619 Cedar Lane, Bracebridge ON",lat:45.064500,lng:-79.304100},
  {id:"p21",order:21,name:"Rhonda",addr:"120 Ann St, Bracebridge ON",lat:45.046900,lng:-79.310100},
  {id:"p22",order:22,name:"Karen",addr:"12 Church St, Bracebridge ON",lat:45.038035,lng:-79.313461},
  {id:"p23",order:23,name:"Tony",addr:"126 Holditch St, Bracebridge ON",lat:45.034379,lng:-79.315852},
  {id:"p24",order:24,name:"Wellington Apts 37/39",addr:"37 Wellington St, Bracebridge ON",lat:45.040341,lng:-79.320011},
  {id:"p25",order:25,name:"Wellington Apts 94",addr:"94 Wellington St, Bracebridge ON",lat:45.042517,lng:-79.322305},
  {id:"p26",order:26,name:"53 Ewing",addr:"53 Ewing St, Bracebridge ON",lat:45.034274,lng:-79.320241},
  {id:"p27",order:27,name:"57 Ewing",addr:"57 Ewing St, Bracebridge ON",lat:45.034374,lng:-79.320341},
  {id:"p28",order:28,name:"65 Ewing",addr:"65 Ewing St, Bracebridge ON",lat:45.034474,lng:-79.320441},
  {id:"p29",order:29,name:"91 Ewing",addr:"91 Ewing St, Bracebridge ON",lat:45.034474,lng:-79.320641},
  {id:"p30",order:30,name:"93 Ewing",addr:"93 Ewing St, Bracebridge ON",lat:45.034374,lng:-79.320741},
  {id:"p31",order:31,name:"19 Inveraray",addr:"19 Inveraray Ave, Bracebridge ON",lat:45.038200,lng:-79.322500},
  {id:"p32",order:32,name:"35 Inveraray Crt",addr:"35 Inveraray Crt, Bracebridge ON",lat:45.038400,lng:-79.322700},
  {id:"p33",order:33,name:"47 Inveraray",addr:"47 Inveraray Ave, Bracebridge ON",lat:45.038600,lng:-79.322900},
  {id:"p34",order:34,name:"281 Dill St",addr:"281 Dill St, Bracebridge ON",lat:45.035066,lng:-79.322819},
  {id:"p35",order:35,name:"289 Dill St",addr:"289 Dill St, Bracebridge ON",lat:45.035166,lng:-79.322919},
  {id:"p36",order:36,name:"243 Dill St",addr:"243 Dill St, Bracebridge ON",lat:45.034966,lng:-79.322719},
  {id:"p37",order:37,name:"67 Spencer St",addr:"67 Spencer St, Bracebridge ON",lat:45.038081,lng:-79.320626},
  {id:"p38",order:38,name:"69 Spencer St",addr:"69 Spencer St, Bracebridge ON",lat:45.038200,lng:-79.320696},
  {id:"p39",order:39,name:"11 Andrea Dr",addr:"11 Andrea Dr, Bracebridge ON",lat:45.036852,lng:-79.321854},
  {id:"p40",order:40,name:"Summer",addr:"38 Killdeer, Bracebridge ON",lat:45.047094,lng:-79.333188},
  {id:"p41",order:41,name:"Lindsay",addr:"21 Killdeer, Bracebridge ON",lat:45.047294,lng:-79.333388},
  {id:"p42",order:42,name:"June",addr:"50 Killdeer, Bracebridge ON",lat:45.046894,lng:-79.332988},
  {id:"p43",order:43,name:"31 Fawnbrook",addr:"31 Fawnbrook Cres, Bracebridge ON",lat:45.057878,lng:-79.323654},
  {id:"p44",order:44,name:"31 Hunter Pl",addr:"31 Hunter Place, Bracebridge ON",lat:45.059259,lng:-79.320122},
  {id:"p45",order:45,name:"33 Hunter Pl",addr:"33 Hunter Place, Bracebridge ON",lat:45.059159,lng:-79.320222},
  {id:"p46",order:46,name:"5 Hunter Pl",addr:"5 Hunter Place, Bracebridge ON",lat:45.059359,lng:-79.320322},
  {id:"p47",order:47,name:"21 Browning",addr:"21 Browning Blvd, Bracebridge ON",lat:45.061295,lng:-79.317362},
  {id:"p48",order:48,name:"56 Chamberry",addr:"56 Chamberry, Bracebridge ON",lat:45.061000,lng:-79.319000},
  {id:"p49",order:49,name:"52 Dyer Cres",addr:"52 Dyer Cres, Bracebridge ON",lat:45.060437,lng:-79.314378},
  {id:"p50",order:50,name:"39 Stother",addr:"39 Stother Cres, Bracebridge ON",lat:45.058658,lng:-79.316903},
  {id:"p51",order:51,name:"3 Clearstream",addr:"3 Clearstream Crt, Bracebridge ON",lat:45.064367,lng:-79.321506},
  {id:"p52",order:52,name:"31 Gladys Ave",addr:"31 Gladys Ave, Bracebridge ON",lat:45.065945,lng:-79.326820},
  {id:"p53",order:53,name:"20 Doland St",addr:"20 Doland St, Bracebridge ON",lat:45.063000,lng:-79.323000},
  {id:"p54",order:54,name:"106 Meadow Heights",addr:"106 Meadow Heights Dr, Bracebridge ON",lat:45.055764,lng:-79.339821},
  {id:"p55",order:55,name:"120 Meadow Heights",addr:"120 Meadow Heights Dr, Bracebridge ON",lat:45.055864,lng:-79.339921},
  {id:"p56",order:56,name:"38 Brian Rd",addr:"38 Brian Rd, Bracebridge ON",lat:45.054912,lng:-79.337888},
  {id:"p57",order:57,name:"21 Brian Rd",addr:"21 Brian Rd, Bracebridge ON",lat:45.055012,lng:-79.337988},
  {id:"p58",order:58,name:"11 Daleman Dr",addr:"11 Daleman Dr, Bracebridge ON",lat:45.053811,lng:-79.336569},
  {id:"p59",order:59,name:"72 Glendale Rd",addr:"72 Glendale Rd, Bracebridge ON",lat:45.050225,lng:-79.328401},
  {id:"p60",order:60,name:"22 Kaye Rd",addr:"22 Kaye Rd, Bracebridge ON",lat:45.054339,lng:-79.335000},
];

const fbApp=initializeApp(firebaseConfig),auth=getAuth(fbApp),db=getDatabase(fbApp);
let map,myDot,markers={},routeData={},gpsWatchId=null,currentUser=null;

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app-screen').style.display='flex';
    document.getElementById('driver-label').textContent=user.email.split('@')[0];
    if(!map)initMap();
    listenRoute();
    startGPS();
  }else{
    currentUser=null;
    document.getElementById('login-screen').style.display='flex';
    document.getElementById('app-screen').style.display='none';
    if(gpsWatchId!==null){navigator.geolocation.clearWatch(gpsWatchId);gpsWatchId=null;}
  }
});

async function doLogin(){
  const email=document.getElementById('inp-email').value.trim();
  const pass=document.getElementById('inp-pass').value;
  const errEl=document.getElementById('login-error');
  errEl.textContent='';
  if(!email||!pass){errEl.textContent='Please enter email and password.';return;}
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    const msgs={
      'auth/invalid-credential':'Wrong email or password.',
      'auth/user-not-found':'No account found.',
      'auth/wrong-password':'Incorrect password.',
      'auth/invalid-email':'Invalid email.',
      'auth/too-many-requests':'Too many attempts.'
    };
    errEl.textContent=msgs[e.code]||'Sign in failed. ('+e.code+')';
  }
}

document.getElementById('signin-btn').addEventListener('click',doLogin);
document.getElementById('signout-btn').addEventListener('click',async()=>{if(confirm('Sign out?'))await signOut(auth);});
document.getElementById('inp-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

function initMap(){
  map=L.map('map',{zoomControl:true}).setView([45.031,-79.320],14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
}

function listenRoute(){
  onValue(ref(db,'route/properties'),snap=>{
    routeData=snap.val()||{};
    renderMarkers();
    renderList();
    renderProgress();
  });
}

function isDone(id){return routeData[id]&&routeData[id].done===true;}

function markerIcon(order,done){
  const bg=done?'#2e7d32':'#c62828';
  return L.divIcon({
    className:'',
    html:'<div style="background:'+bg+';width:30px;height:30px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:12px;">'+order+'</div>',
    iconSize:[30,30],
    iconAnchor:[15,15]
  });
}

function renderMarkers(){
  PROPERTIES.forEach(p=>{
    const done=isDone(p.id);
    if(markers[p.id])map.removeLayer(markers[p.id]);
    const m=L.marker([p.lat,p.lng],{icon:markerIcon(p.order,done)}).addTo(map)
      .bindPopup('<b>#'+p.order+' - '+p.name+'</b><br>'+p.addr+'<br>'+(done?'Done':'Pending'));
    if(!done)m.on('click',()=>markDone(p.id));
    markers[p.id]=m;
  });
}

function renderList(){
  const el=document.getElementById('prop-list');
  el.innerHTML='';
  PROPERTIES.forEach(p=>{
    const done=isDone(p.id);
    const row=document.createElement('div');
    row.className='prop-item'+(done?' done':'');
    const badge=document.createElement('div');
    badge.className='stop-badge '+(done?'done':'pending');
    badge.textContent=p.order;
    const text=document.createElement('div');
    text.className='prop-text';
    text.innerHTML='<div class="prop-name">'+p.name+'</div><div class="prop-addr">'+p.addr+'</div>';
    row.appendChild(badge);
    row.appendChild(text);
    if(done){
      const s=document.createElement('span');
      s.className='prop-status done';
      s.textContent='DONE';
      row.appendChild(s);
    }else{
      const btn=document.createElement('button');
      btn.className='btn btn-green btn-sm';
      btn.textContent='Done';
      btn.addEventListener('click',()=>markDone(p.id));
      row.appendChild(btn);
    }
    el.appendChild(row);
  });
}

function renderProgress(){
  const total=PROPERTIES.length,doneCount=PROPERTIES.filter(p=>isDone(p.id)).length;
  document.getElementById('prog-text').textContent=doneCount+' / '+total+' driveways complete';
}

async function markDone(id){
  const p=PROPERTIES.find(x=>x.id===id);
  if(!p||isDone(id))return;
  if(!confirm('Mark Stop #'+p.order+' "'+p.name+'" as complete?'))return;
  await update(ref(db,'route/properties/'+id),{
    done:true,
    completedBy:currentUser?currentUser.email:'unknown',
    completedAt:serverTimestamp()
  });
}

function startGPS(){
  if(!navigator.geolocation){document.getElementById('gps-text').textContent='GPS unavailable';return;}
  const tractorIcon=L.divIcon({
    className:'',
    html:'<div style="background:#1565c0;width:22px;height:22px;border-radius:50%;border:3px solid #fff;box-shadow:0 0 10px #1565c0;"></div>',
    iconSize:[22,22],
    iconAnchor:[11,11]
  });
  gpsWatchId=navigator.geolocation.watchPosition(pos=>{
    const{latitude:lat,longitude:lng}=pos.coords;
    document.getElementById('gps-text').textContent='GPS active';
    if(!myDot){
      myDot=L.marker([lat,lng],{icon:tractorIcon,zIndexOffset:1000}).addTo(map).bindPopup('You are here');
    }else{
      myDot.setLatLng([lat,lng]);
    }
    const uid=currentUser?currentUser.uid:'unknown';
    set(ref(db,'operators/'+uid),{
      email:currentUser?currentUser.email:'',
      lat,lng,
      updatedAt:serverTimestamp()
    });
  },()=>{
    document.getElementById('gps-text').textContent='GPS error';
  },{enableHighAccuracy:true,maximumAge:4000,timeout:10000});
}
</script>
</body>
</html>
